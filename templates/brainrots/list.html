{% extends "base.html" %}

{% block title %}Brainrots - Brainrot Manager{% endblock %}

{% block extra_css %}
<style>
    .filter-card {
        transition: all 0.3s ease;
    }
    
    .filter-card:hover {
        transform: translateY(-2px);
    }
    
    .brainrot-card {
        transition: all 0.3s ease;
        cursor: pointer;
    }
    
    .brainrot-card:hover {
        transform: scale(1.02);
    }
    
    /* Estilos para drag-and-drop */
    .sortable-ghost {
        opacity: 0.4;
        background: #f3f4f6 !important;
    }
    
    .sortable-drag {
        opacity: 0.8;
        transform: rotate(2deg);
    }
    
    .brainrot-card {
        cursor: pointer;
    }
    
    .modo-organizacao .brainrot-card {
        cursor: grab;
    }
    
    .modo-organizacao .brainrot-card:active {
        cursor: grabbing;
    }
    
    .modo-organizacao .brainrot-card:hover {
        transform: scale(1.02);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    
    .indicador-modo-organizacao {
        background: #fbbf24;
        color: #1f2937;
        padding: 0.5rem 1rem;
        border-radius: 0.5rem;
        font-size: 0.875rem;
        font-weight: 600;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .indicador-modo-organizacao.hidden {
        display: none;
    }
</style>
{% endblock %}

{% block content %}
<div class="fade-in">
    <!-- Cabeçalho -->
    <div class="mb-6">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-4 gap-4">
            <div>
                <h1 class="text-2xl md:text-3xl font-bold text-white mb-2">
                    <i class="fas fa-cube mr-2 md:mr-3"></i>Gerenciar Brainrots
                </h1>
                <p class="text-white/80 text-xs md:text-sm">
                    <i class="fas fa-info-circle mr-1"></i>Total de Brainrots: <span class="font-bold text-white">{{ total_brainrots if total_brainrots is defined else 0 }}</span>
                </p>
            </div>
            <div class="flex flex-col sm:flex-row items-stretch sm:items-center gap-2 sm:gap-3">
                <button id="btn-organizar" onclick="toggleModoOrganizacao()" 
                        class="bg-yellow-600 hover:bg-yellow-700 text-white px-4 py-2 md:px-6 md:py-3 rounded-lg font-medium transition-colors text-sm md:text-base">
                    <i class="fas fa-grip-vertical mr-2"></i><span id="texto-btn-organizar">Organizar Cards</span>
                </button>
                <a href="{{ url_for('brainrot_new') }}" class="btn-primary text-white px-4 py-2 md:px-6 md:py-3 rounded-lg font-medium hover:no-underline text-sm md:text-base text-center">
                    <i class="fas fa-plus mr-2"></i>Novo Brainrot
                </a>
            </div>
        </div>
        
        <!-- Contadores por Raridade -->
        {% if brainrots_por_raridade is defined %}
        <div class="card rounded-xl shadow-xl p-3 md:p-4 mb-4">
            <h3 class="text-base md:text-lg font-bold text-gray-800 mb-3">
                <i class="fas fa-chart-bar mr-2 text-purple-600"></i>Brainrots por Raridade
            </h3>
            <div class="grid grid-cols-2 sm:grid-cols-4 md:grid-cols-4 lg:grid-cols-8 gap-2 md:gap-3">
                {% set raridades_lista = ['Comum', 'Raro', 'Épico', 'Lendário', 'Mítico', 'Deus Brainrot', 'Secreto', 'OG'] %}
                {% for raridade in raridades_lista %}
                <div class="text-center p-2 rounded-lg bg-gray-50 flex flex-col items-center">
                    <span class="inline-block px-2 py-1 rounded text-xs font-medium raridade-{{ raridade.lower().replace(' ', '-') }} mb-1 w-full min-h-[32px] flex items-center justify-center text-center">
                        {{ raridade }}
                    </span>
                    <p class="text-xl font-bold text-gray-800">{{ brainrots_por_raridade.get(raridade, 0) }}</p>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </div>
    
    <!-- Filtros -->
    <div class="card rounded-xl shadow-xl p-4 md:p-6 mb-6 filter-card">
        <h2 class="text-lg md:text-xl font-bold text-gray-800 mb-4">
            <i class="fas fa-filter mr-2 text-purple-600"></i>Filtros e Busca
        </h2>
        
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-3 md:gap-4">
            <!-- Busca -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Buscar por nome</label>
                <input type="text" id="busca" placeholder="Digite o nome..." 
                       class="input-modern w-full px-4 py-2 rounded-lg focus:outline-none">
            </div>
            
            <!-- Raridade -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Raridade</label>
                <select id="raridade" class="input-modern w-full px-4 py-2 rounded-lg focus:outline-none">
                    <option value="">Todas</option>
                    <option value="Comum">Comum</option>
                    <option value="Raro">Raro</option>
                    <option value="Épico">Épico</option>
                    <option value="Lendário">Lendário</option>
                    <option value="Mítico">Mítico</option>
                    <option value="Deus Brainrot">Deus Brainrot</option>
                    <option value="Secreto">Secreto</option>
                    <option value="OG">OG</option>
                </select>
            </div>
            
            <!-- Formato de Valor -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Formato Valor</label>
                <select id="valor_formato" class="input-modern w-full px-4 py-2 rounded-lg focus:outline-none">
                    <option value="">Todos</option>
                    <option value="/s">/s</option>
                    <option value="K/s">K/s</option>
                    <option value="M/s">M/s</option>
                    <option value="B/s">B/s</option>
                </select>
            </div>
            
            <!-- Valor Mínimo -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Valor Mín.</label>
                <input type="number" id="valor_min" step="0.01" placeholder="0.00" 
                       class="input-modern w-full px-4 py-2 rounded-lg focus:outline-none">
            </div>
            
            <!-- Valor Máximo -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Valor Máx.</label>
                <input type="number" id="valor_max" step="0.01" placeholder="9999.99" 
                       class="input-modern w-full px-4 py-2 rounded-lg focus:outline-none">
            </div>
        </div>
        
        <!-- Filtro por Evento -->
        <div class="mt-4">
            <label class="block text-sm font-medium text-gray-700 mb-2">Filtrar por Evento</label>
            <select id="evento" class="input-modern w-full md:w-1/2 lg:w-1/3 px-4 py-2 rounded-lg focus:outline-none">
                <option value="">Todos os eventos</option>
                <option value="10B">10B</option>
                <option value="1x1x1x1">1x1x1x1</option>
                <option value="4 de Julho">4 de Julho</option>
                <option value="Sangue Podre">Sangue Podre</option>
                <option value="Bombardeiro">Bombardeiro</option>
                <option value="Brasil">Brasil</option>
                <option value="Doce">Doce</option>
                <option value="Celestial">Celestial</option>
                <option value="Concerto">Concerto</option>
                <option value="Crab Rave">Crab Rave</option>
                <option value="Diamante">Diamante</option>
                <option value="Extinto">Extinto</option>
                <option value="Fogo">Fogo</option>
                <option value="Galáxia">Galáxia</option>
                <option value="Falha">Falha</option>
                <option value="Ouro">Ouro</option>
                <option value="Indonésia">Indonésia</option>
                <option value="Lava">Lava</option>
                <option value="Relâmpago">Relâmpago</option>
                <option value="Matteo">Matteo</option>
                <option value="Meowl">Meowl</option>
                <option value="México">México</option>
                <option value="Gatos Nyan">Gatos Nyan</option>
                <option value="Pintura">Pintura</option>
                <option value="Abóbora">Abóbora</option>
                <option value="Radioativo">Radioativo</option>
                <option value="Chuva">Chuva</option>
                <option value="Arco-íris">Arco-íris</option>
                <option value="Chovendo Tacos">Chovendo Tacos</option>
                <option value="RIP">RIP</option>
                <option value="Tubarão">Tubarão</option>
                <option value="Sonolento">Sonolento</option>
                <option value="Neve">Neve</option>
                <option value="Aranha">Aranha</option>
                <option value="Queda de Estrelas">Queda de Estrelas</option>
                <option value="Morango">Morango</option>
                <option value="Gravata">Gravata</option>
                <option value="Ataque Tung Tung">Ataque Tung Tung</option>
                <option value="OVNI">OVNI</option>
                <option value="Bruxa">Bruxa</option>
                <option value="Yin-Yang">Yin-Yang</option>
            </select>
        </div>
        
        <div class="mt-4 flex flex-col sm:flex-row justify-end gap-2 sm:gap-0">
            <button onclick="aplicarFiltros()" class="btn-primary text-white px-4 py-2 md:px-6 md:py-2 rounded-lg font-medium text-sm md:text-base w-full sm:w-auto">
                <i class="fas fa-search mr-2"></i>Aplicar Filtros
            </button>
            <button onclick="limparFiltros()" class="bg-gray-500 text-white px-4 py-2 md:px-6 md:py-2 rounded-lg font-medium sm:ml-3 hover:bg-gray-600 transition-colors text-sm md:text-base w-full sm:w-auto">
                <i class="fas fa-redo mr-2"></i>Limpar
            </button>
        </div>
    </div>
    
    <!-- Indicador de Modo Organização -->
    <div id="indicador-organizacao" class="indicador-modo-organizacao hidden">
        <i class="fas fa-info-circle"></i>
        <span>Modo de organização ativado. Arraste os cards para reorganizá-los.</span>
    </div>
    
    <!-- Lista de Brainrots -->
    <div id="brainrots-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
        <!-- Os brainrots serão carregados via JavaScript -->
    </div>
    
    <!-- Loading -->
    <div id="loading" class="text-center py-12">
        <i class="fas fa-spinner fa-spin text-4xl text-white"></i>
        <p class="text-white mt-4">Carregando Brainrots...</p>
    </div>
    
    <!-- Empty State -->
    <div id="empty-state" class="hidden card rounded-xl shadow-xl p-12 text-center">
        <i class="fas fa-cube text-6xl text-gray-400 mb-4"></i>
        <h3 class="text-2xl font-bold text-gray-800 mb-2">Nenhum Brainrot encontrado</h3>
        <p class="text-gray-600 mb-6">Comece adicionando seu primeiro Brainrot!</p>
        <a href="{{ url_for('brainrot_new') }}" class="btn-primary text-white px-6 py-3 rounded-lg font-medium inline-block hover:no-underline">
            <i class="fas fa-plus mr-2"></i>Criar Brainrot
        </a>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- SortableJS para drag-and-drop -->
<script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
<script>
    // Carregar brainrots ao iniciar
    $(document).ready(function() {
        carregarBrainrots();
        
        // Filtro automático por partes do nome (enquanto digita)
        let buscaTimeout;
        $('#busca').on('input', function() {
            clearTimeout(buscaTimeout);
            buscaTimeout = setTimeout(function() {
                aplicarFiltros();
            }, 300); // Aguarda 300ms após parar de digitar
        });
        
        // Aplicar filtros ao pressionar Enter ou mudar seleções
        $('#raridade, #valor_formato, #valor_min, #valor_max, #evento').on('change', function() {
            aplicarFiltros();
        });
        
        $('#raridade, #valor_min, #valor_max').on('keypress', function(e) {
            if (e.which === 13) {
                aplicarFiltros();
            }
        });
    });
    
    function carregarBrainrots() {
        $('#loading').show();
        $('#empty-state').addClass('hidden');
        
        const params = new URLSearchParams();
        params.append('busca', $('#busca').val());
        params.append('raridade', $('#raridade').val());
        params.append('valor_formato', $('#valor_formato').val());
        params.append('valor_min', $('#valor_min').val());
        params.append('valor_max', $('#valor_max').val());
        params.append('evento', $('#evento').val());
        
        $.get('/api/brainrots?' + params.toString(), function(data) {
            $('#loading').hide();
            
            if (data.length === 0) {
                $('#brainrots-container').html('');
                $('#empty-state').removeClass('hidden');
                return;
            }
            
            let html = '';
            data.forEach(function(brainrot, index) {
                // Formatar eventos
                const eventos = brainrot.eventos || [];
                const eventosTexto = eventos.length > 0 ? eventos.join(', ') : 'Nenhum';
                
                html += `
                    <div class="brainrot-card card rounded-xl shadow-xl p-4 animate__animated animate__fadeInUp card-raridade-${brainrot.raridade.toLowerCase().replace(/\s+/g, '-')}" 
                         data-id="${brainrot.id}"
                         style="animation-delay: ${index * 0.05}s"
                         onclick="if (!window.isDragging) window.location.href='${'/brainrots/' + brainrot.id + '/editar'}'">
                        <div class="flex items-start space-x-3 mb-3">
                            ${brainrot.foto && brainrot.foto.startsWith('http') ? 
                                `<img src="${brainrot.foto}" alt="${brainrot.nome}" class="w-16 h-16 md:w-20 md:h-20 object-cover rounded-lg flex-shrink-0" loading="lazy" onerror="this.style.display='none'; if(this.nextElementSibling) this.nextElementSibling.style.display='flex';" onload="if(this.nextElementSibling) this.nextElementSibling.style.display='none';"><div class="w-16 h-16 md:w-20 md:h-20 bg-gray-300 rounded-lg items-center justify-center flex-shrink-0 hidden"><i class="fas fa-cube text-gray-500 text-lg md:text-xl"></i></div>` :
                                brainrot.foto && !brainrot.foto.startsWith('http') ?
                                `<img src="/uploads/${brainrot.foto.split('/').pop()}" alt="${brainrot.nome}" class="w-16 h-16 md:w-20 md:h-20 object-cover rounded-lg flex-shrink-0" loading="lazy" onerror="this.style.display='none'; if(this.nextElementSibling) this.nextElementSibling.style.display='flex';" onload="if(this.nextElementSibling) this.nextElementSibling.style.display='none';"><div class="w-16 h-16 md:w-20 md:h-20 bg-gray-300 rounded-lg items-center justify-center flex-shrink-0 hidden"><i class="fas fa-cube text-gray-500 text-lg md:text-xl"></i></div>` :
                                `<div class="w-16 h-16 md:w-20 md:h-20 bg-gray-300 rounded-lg flex items-center justify-center flex-shrink-0">
                                    <i class="fas fa-cube text-gray-500 text-lg md:text-xl"></i>
                                </div>`
                            }
                            <div class="flex-1 min-w-0">
                                <h3 class="text-lg font-bold text-gray-800 mb-1 truncate">${brainrot.nome}</h3>
                                <span class="inline-block px-2 py-1 rounded text-xs font-medium raridade-${brainrot.raridade.toLowerCase().replace(/\s+/g, '-')}">
                                    ${brainrot.raridade}
                                </span>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-2 text-xs mb-3">
                            <div>
                                <p class="text-gray-600">Valor/s</p>
                                <p class="font-bold text-gray-800 text-sm">${brainrot.valor_range || brainrot.valor_formatado || formatarValorPorSegundo(brainrot.valor_por_segundo)}</p>
                                ${brainrot.tem_multiplos ? `<p class="text-xs text-gray-500 mt-0.5">${brainrot.total_instancias} inst.</p>` : ''}
                            </div>
                            <div>
                                <p class="text-gray-600">Qtd</p>
                                <p class="font-bold text-gray-800 text-sm">${brainrot.quantidade}</p>
                            </div>
                        </div>
                        <div class="mb-3">
                            <p class="text-gray-600 text-xs mb-1">Eventos</p>
                            <p class="font-medium text-gray-800 text-xs truncate" title="${eventosTexto}">${eventosTexto}</p>
                        </div>
                        <div class="pt-3 border-t border-gray-200">
                            <button onclick="event.stopPropagation(); deletarBrainrot(${brainrot.id})" 
                                    class="text-red-600 hover:text-red-700 text-xs font-medium">
                                <i class="fas fa-trash mr-1"></i>Excluir
                            </button>
                        </div>
                    </div>
                `;
            });
            
            $('#brainrots-container').html(html);
            
            // Inicializar SortableJS para drag-and-drop apenas se o modo de organização estiver ativo
            if (modoOrganizacaoAtivo) {
                inicializarSortable();
            }
        });
    }
    
    // Variável global para rastrear se está arrastando
    window.isDragging = false;
    let sortable = null;
    let modoOrganizacaoAtivo = false;
    
    function toggleModoOrganizacao() {
        modoOrganizacaoAtivo = !modoOrganizacaoAtivo;
        
        if (modoOrganizacaoAtivo) {
            // Ativar modo de organização
            $('body').addClass('modo-organizacao');
            $('#indicador-organizacao').removeClass('hidden');
            $('#texto-btn-organizar').text('Sair do Modo Organização');
            $('#btn-organizar').removeClass('bg-yellow-600 hover:bg-yellow-700').addClass('bg-red-600 hover:bg-red-700');
            
            // Inicializar SortableJS se ainda não estiver inicializado
            inicializarSortable();
        } else {
            // Desativar modo de organização
            $('body').removeClass('modo-organizacao');
            $('#indicador-organizacao').addClass('hidden');
            $('#texto-btn-organizar').text('Organizar Cards');
            $('#btn-organizar').removeClass('bg-red-600 hover:bg-red-700').addClass('bg-yellow-600 hover:bg-yellow-700');
            
            // Destruir SortableJS
            if (sortable) {
                sortable.destroy();
                sortable = null;
            }
        }
    }
    
    function inicializarSortable() {
        // Só inicializar se o modo de organização estiver ativo
        if (!modoOrganizacaoAtivo) {
            return;
        }
        
        const container = document.getElementById('brainrots-container');
        if (!container) return;
        
        // Destruir sortable anterior se existir
        if (sortable) {
            sortable.destroy();
        }
        
        sortable = new Sortable(container, {
            animation: 150,
            ghostClass: 'sortable-ghost',
            dragClass: 'sortable-drag',
            handle: '.brainrot-card', // Pode arrastar por qualquer parte do card
            disabled: false, // Habilitar arrastar
            onStart: function(evt) {
                window.isDragging = true;
            },
            onEnd: function(evt) {
                window.isDragging = false;
                
                // Salvar nova ordem
                const items = container.querySelectorAll('.brainrot-card');
                const orders = [];
                
                items.forEach(function(item, index) {
                    const brainrotId = parseInt(item.getAttribute('data-id'));
                    if (brainrotId) {
                        orders.push({
                            id: brainrotId,
                            ordem: index
                        });
                    }
                });
                
                // Enviar nova ordem para o servidor
                $.ajax({
                    url: '/api/brainrots/reorder',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ orders: orders }),
                    success: function(response) {
                        if (response.success) {
                            // Atualizar visualmente se necessário
                            console.log('Ordem atualizada com sucesso!');
                        }
                    },
                    error: function(xhr) {
                        console.error('Erro ao salvar ordem:', xhr);
                        // Reverter ordem ou mostrar mensagem
                        carregarBrainrots(); // Recarregar para voltar à ordem anterior
                    }
                });
            }
        });
    }
    
    function aplicarFiltros() {
        carregarBrainrots();
    }
    
    function limparFiltros() {
        $('#busca').val('');
        $('#raridade').val('');
        $('#valor_formato').val('');
        $('#valor_min').val('');
        $('#valor_max').val('');
        $('#evento').val('');
        carregarBrainrots();
    }
    
    function formatarValorPorSegundo(valor) {
        if (!valor || valor === 0) return '$0/s';
        if (valor >= 1000000000) return `$${(valor/1000000000).toFixed(1)}B/s`;
        if (valor >= 1000000) return `$${(valor/1000000).toFixed(1)}M/s`;
        if (valor >= 1000) return `$${(valor/1000).toFixed(1)}K/s`;
        return `$${valor.toFixed(0)}/s`;
    }
    
    function deletarBrainrot(id) {
        if (confirm('Tem certeza que deseja excluir este Brainrot?')) {
            $.ajax({
                url: '/api/brainrots/' + id,
                type: 'DELETE',
                success: function() {
                    carregarBrainrots();
                },
                error: function() {
                    alert('Erro ao excluir Brainrot');
                }
            });
        }
    }
</script>
{% endblock %}

