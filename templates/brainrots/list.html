{% extends "base.html" %}

{% block title %}Brainrots - Brainrot Manager{% endblock %}

{% block extra_css %}
<style>
    .filter-card {
        transition: all 0.3s ease;
    }
    
    .filter-card:hover {
        transform: translateY(-2px);
    }
    
    .brainrot-card {
        transition: all 0.3s ease;
        cursor: pointer;
    }
    
    .brainrot-card:hover {
        transform: scale(1.02);
    }
    
    /* Estilos para drag-and-drop */
    .sortable-ghost {
        opacity: 0.4;
        background: #f3f4f6 !important;
    }
    
    .sortable-drag {
        opacity: 0.8;
        transform: rotate(2deg);
    }
    
    .brainrot-card {
        cursor: grab;
    }
    
    .brainrot-card:active {
        cursor: grabbing;
    }
</style>
{% endblock %}

{% block content %}
<div class="fade-in">
    <!-- Cabeçalho -->
    <div class="flex items-center justify-between mb-6">
        <h1 class="text-3xl font-bold text-white">
            <i class="fas fa-cube mr-3"></i>Gerenciar Brainrots
        </h1>
        <a href="{{ url_for('brainrot_new') }}" class="btn-primary text-white px-6 py-3 rounded-lg font-medium hover:no-underline">
            <i class="fas fa-plus mr-2"></i>Novo Brainrot
        </a>
    </div>
    
    <!-- Filtros -->
    <div class="card rounded-xl shadow-xl p-6 mb-6 filter-card">
        <h2 class="text-xl font-bold text-gray-800 mb-4">
            <i class="fas fa-filter mr-2 text-purple-600"></i>Filtros e Busca
        </h2>
        
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
            <!-- Busca -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Buscar por nome</label>
                <input type="text" id="busca" placeholder="Digite o nome..." 
                       class="input-modern w-full px-4 py-2 rounded-lg focus:outline-none">
            </div>
            
            <!-- Raridade -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Raridade</label>
                <select id="raridade" class="input-modern w-full px-4 py-2 rounded-lg focus:outline-none">
                    <option value="">Todas</option>
                    <option value="Comum">Comum</option>
                    <option value="Raro">Raro</option>
                    <option value="Épico">Épico</option>
                    <option value="Lendário">Lendário</option>
                    <option value="Mítico">Mítico</option>
                    <option value="Deus Brainrot">Deus Brainrot</option>
                    <option value="Secreto">Secreto</option>
                    <option value="OG">OG</option>
                </select>
            </div>
            
            <!-- Valor Mínimo -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Valor Mín./s</label>
                <input type="number" id="valor_min" step="0.01" placeholder="0.00" 
                       class="input-modern w-full px-4 py-2 rounded-lg focus:outline-none">
            </div>
            
            <!-- Valor Máximo -->
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Valor Máx./s</label>
                <input type="number" id="valor_max" step="0.01" placeholder="9999.99" 
                       class="input-modern w-full px-4 py-2 rounded-lg focus:outline-none">
            </div>
        </div>
        
        <div class="mt-4 flex justify-end">
            <button onclick="aplicarFiltros()" class="btn-primary text-white px-6 py-2 rounded-lg font-medium">
                <i class="fas fa-search mr-2"></i>Aplicar Filtros
            </button>
            <button onclick="limparFiltros()" class="bg-gray-500 text-white px-6 py-2 rounded-lg font-medium ml-3 hover:bg-gray-600 transition-colors">
                <i class="fas fa-redo mr-2"></i>Limpar
            </button>
        </div>
    </div>
    
    <!-- Lista de Brainrots -->
    <div id="brainrots-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        <!-- Os brainrots serão carregados via JavaScript -->
    </div>
    
    <!-- Loading -->
    <div id="loading" class="text-center py-12">
        <i class="fas fa-spinner fa-spin text-4xl text-white"></i>
        <p class="text-white mt-4">Carregando Brainrots...</p>
    </div>
    
    <!-- Empty State -->
    <div id="empty-state" class="hidden card rounded-xl shadow-xl p-12 text-center">
        <i class="fas fa-cube text-6xl text-gray-400 mb-4"></i>
        <h3 class="text-2xl font-bold text-gray-800 mb-2">Nenhum Brainrot encontrado</h3>
        <p class="text-gray-600 mb-6">Comece adicionando seu primeiro Brainrot!</p>
        <a href="{{ url_for('brainrot_new') }}" class="btn-primary text-white px-6 py-3 rounded-lg font-medium inline-block hover:no-underline">
            <i class="fas fa-plus mr-2"></i>Criar Brainrot
        </a>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- SortableJS para drag-and-drop -->
<script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
<script>
    // Carregar brainrots ao iniciar
    $(document).ready(function() {
        carregarBrainrots();
        
        // Aplicar filtros ao pressionar Enter
        $('#busca, #raridade, #valor_min, #valor_max').on('keypress', function(e) {
            if (e.which === 13) {
                aplicarFiltros();
            }
        });
    });
    
    function carregarBrainrots() {
        $('#loading').show();
        $('#empty-state').addClass('hidden');
        
        const params = new URLSearchParams();
        params.append('busca', $('#busca').val());
        params.append('raridade', $('#raridade').val());
        params.append('valor_min', $('#valor_min').val());
        params.append('valor_max', $('#valor_max').val());
        
        $.get('/api/brainrots?' + params.toString(), function(data) {
            $('#loading').hide();
            
            if (data.length === 0) {
                $('#brainrots-container').html('');
                $('#empty-state').removeClass('hidden');
                return;
            }
            
            let html = '';
            data.forEach(function(brainrot, index) {
                html += `
                    <div class="brainrot-card card rounded-xl shadow-xl p-6 animate__animated animate__fadeInUp card-raridade-${brainrot.raridade.toLowerCase().replace(/\s+/g, '-')}" 
                         data-id="${brainrot.id}"
                         style="animation-delay: ${index * 0.1}s"
                         onclick="if (!window.isDragging) window.location.href='${'/brainrots/' + brainrot.id + '/editar'}'">
                        <div class="flex items-start space-x-4 mb-4">
                            ${brainrot.foto ? 
                                `<img src="/uploads/${brainrot.foto.split('/').pop()}" alt="${brainrot.nome}" class="w-32 h-32 object-cover rounded-lg">` :
                                `<div class="w-32 h-32 bg-gray-300 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-cube text-gray-500 text-3xl"></i>
                                </div>`
                            }
                            <div class="flex-1">
                                <h3 class="text-xl font-bold text-gray-800 mb-2">${brainrot.nome}</h3>
                                <span class="inline-block px-3 py-1 rounded text-sm font-medium raridade-${brainrot.raridade.toLowerCase().replace(/\s+/g, '-')} mb-2">
                                    ${brainrot.raridade}
                                </span>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4 text-sm">
                            <div>
                                <p class="text-gray-600">Valor/s</p>
                                <p class="font-bold text-gray-800">${brainrot.valor_formatado || formatarValorPorSegundo(brainrot.valor_por_segundo)}</p>
                            </div>
                            <div>
                                <p class="text-gray-600">Quantidade</p>
                                <p class="font-bold text-gray-800">${brainrot.quantidade}</p>
                            </div>
                            <div>
                                <p class="text-gray-600">Mutações</p>
                                <p class="font-bold text-gray-800">${brainrot.numero_mutacoes}</p>
                            </div>
                            <div>
                                <p class="text-gray-600">Contas</p>
                                <p class="font-bold text-gray-800">${brainrot.contas.length}</p>
                            </div>
                        </div>
                        <div class="mt-4 pt-4 border-t border-gray-200">
                            <button onclick="event.stopPropagation(); deletarBrainrot(${brainrot.id})" 
                                    class="text-red-600 hover:text-red-700 text-sm font-medium">
                                <i class="fas fa-trash mr-1"></i>Excluir
                            </button>
                        </div>
                    </div>
                `;
            });
            
            $('#brainrots-container').html(html);
            
            // Inicializar SortableJS para drag-and-drop
            inicializarSortable();
        });
    }
    
    // Variável global para rastrear se está arrastando
    window.isDragging = false;
    let sortable = null;
    
    function inicializarSortable() {
        const container = document.getElementById('brainrots-container');
        if (!container) return;
        
        // Destruir sortable anterior se existir
        if (sortable) {
            sortable.destroy();
        }
        
        sortable = new Sortable(container, {
            animation: 150,
            ghostClass: 'sortable-ghost',
            dragClass: 'sortable-drag',
            handle: '.brainrot-card', // Pode arrastar por qualquer parte do card
            onStart: function(evt) {
                window.isDragging = true;
            },
            onEnd: function(evt) {
                window.isDragging = false;
                
                // Salvar nova ordem
                const items = container.querySelectorAll('.brainrot-card');
                const orders = [];
                
                items.forEach(function(item, index) {
                    const brainrotId = parseInt(item.getAttribute('data-id'));
                    if (brainrotId) {
                        orders.push({
                            id: brainrotId,
                            ordem: index
                        });
                    }
                });
                
                // Enviar nova ordem para o servidor
                $.ajax({
                    url: '/api/brainrots/reorder',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ orders: orders }),
                    success: function(response) {
                        if (response.success) {
                            // Atualizar visualmente se necessário
                            console.log('Ordem atualizada com sucesso!');
                        }
                    },
                    error: function(xhr) {
                        console.error('Erro ao salvar ordem:', xhr);
                        // Reverter ordem ou mostrar mensagem
                        carregarBrainrots(); // Recarregar para voltar à ordem anterior
                    }
                });
            }
        });
    }
    
    function aplicarFiltros() {
        carregarBrainrots();
    }
    
    function limparFiltros() {
        $('#busca').val('');
        $('#raridade').val('');
        $('#valor_min').val('');
        $('#valor_max').val('');
        carregarBrainrots();
    }
    
    function deletarBrainrot(id) {
        if (confirm('Tem certeza que deseja excluir este Brainrot?')) {
            $.ajax({
                url: '/api/brainrots/' + id,
                type: 'DELETE',
                success: function() {
                    carregarBrainrots();
                },
                error: function() {
                    alert('Erro ao excluir Brainrot');
                }
            });
        }
    }
</script>
{% endblock %}

