{% extends "base.html" %}

{% block title %}{% if brainrot %}Editar{% else %}Novo{% endif %} Brainrot - Brainrot Manager{% endblock %}

{% block extra_css %}
<style>
    .upload-area {
        border: 2px dashed #cbd5e1;
        transition: all 0.3s ease;
    }
    
    .upload-area:hover {
        border-color: #667eea;
        background-color: #f3f4f6;
    }
    
    .upload-area.dragover {
        border-color: #667eea;
        background-color: #eef2ff;
    }
</style>
{% endblock %}

{% block content %}
<div class="fade-in">
    <div class="max-w-4xl mx-auto">
        <div class="mb-6">
            <a href="{{ url_for('brainrots_list') }}" class="text-white hover:text-yellow-200 transition-colors">
                <i class="fas fa-arrow-left mr-2"></i>Voltar
            </a>
        </div>
        
        <div class="card rounded-xl shadow-xl p-8">
            <h1 class="text-3xl font-bold text-gray-800 mb-6">
                <i class="fas fa-cube mr-3 text-purple-600"></i>
                {% if brainrot %}Editar Brainrot{% else %}Novo Brainrot{% endif %}
            </h1>
            
            <form id="brainrot-form" class="space-y-6">
                <!-- Nome -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Nome *</label>
                    <input type="text" id="nome" name="nome" required
                           value="{{ brainrot.nome if brainrot else '' }}"
                           class="input-modern w-full px-4 py-3 rounded-lg focus:outline-none"
                           placeholder="Nome do Brainrot">
                </div>
                
                <!-- Foto -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Foto</label>
                    <div class="upload-area rounded-lg p-8 text-center cursor-pointer" id="upload-area">
                        {% if brainrot and brainrot.foto %}
                        <img id="preview-image" src="{{ url_for('uploaded_file', filename=brainrot.foto.split('/')[-1]) }}" 
                             alt="Preview" class="max-w-xs mx-auto rounded-lg mb-4">
                        {% else %}
                        <i class="fas fa-image text-5xl text-gray-400 mb-4"></i>
                        <p class="text-gray-600 mb-2">Clique ou arraste uma imagem aqui</p>
                        <p class="text-sm text-gray-500">PNG, JPG, GIF até 10MB</p>
                        <img id="preview-image" src="" alt="Preview" class="hidden max-w-xs mx-auto rounded-lg mb-4">
                        {% endif %}
                        <input type="file" id="foto-input" accept="image/*" class="hidden">
                        <input type="hidden" id="foto-url" name="foto" value="{{ brainrot.foto if brainrot else '' }}">
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Raridade -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Raridade *</label>
                        <select id="raridade" name="raridade" required
                                class="input-modern w-full px-4 py-3 rounded-lg focus:outline-none">
                            {% for rar in raridades %}
                            <option value="{{ rar }}" {% if brainrot and brainrot.raridade == rar %}selected{% endif %}>
                                {{ rar }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <!-- Valor por Segundo -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Valor por Segundo</label>
                        <div class="flex gap-2">
                            <input type="text" id="valor_numero" name="valor_numero"
                                   value="{% if brainrot and brainrot.valor_formatado %}{{ brainrot.valor_formatado.replace('$', '').replace('/s', '').replace('K/s', '').replace('M/s', '').replace('B/s', '').replace('T/s', '').strip() }}{% else %}0{% endif %}"
                                   class="input-modern flex-1 px-4 py-3 rounded-lg focus:outline-none"
                                   placeholder="0.0">
                            <select id="valor_formato" name="valor_formato"
                                    class="input-modern px-4 py-3 rounded-lg focus:outline-none">
                                <option value="/s">/s</option>
                                <option value="K/s">K/s</option>
                                <option value="M/s">M/s</option>
                                <option value="B/s">B/s</option>
                                <option value="T/s">T/s</option>
                            </select>
                        </div>
                        <input type="hidden" id="valor_formatado" name="valor_formatado">
                    </div>
                    
                    <!-- Quantidade -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Quantidade</label>
                        <input type="number" id="quantidade" name="quantidade" min="1"
                               value="{{ brainrot.quantidade if brainrot else '1' }}"
                               class="input-modern w-full px-4 py-3 rounded-lg focus:outline-none"
                               placeholder="1">
                    </div>
                    
                    <!-- Número de Mutações -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Número de Mutações</label>
                        <input type="number" id="numero_mutacoes" name="numero_mutacoes" min="0"
                               value="{{ brainrot.numero_mutacoes if brainrot else '0' }}"
                               class="input-modern w-full px-4 py-3 rounded-lg focus:outline-none"
                               placeholder="0">
                    </div>
                </div>
                
                <!-- Contas Associadas -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Contas Associadas</label>
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-3 max-h-48 overflow-y-auto border border-gray-200 rounded-lg p-4">
                        {% for conta in contas %}
                        <label class="flex items-center space-x-2 cursor-pointer hover:bg-gray-50 p-2 rounded">
                            <input type="checkbox" name="contas" value="{{ conta.id }}"
                                   {% if brainrot and conta.id in contas_associadas %}checked{% endif %}
                                   class="rounded border-gray-300 text-purple-600 focus:ring-purple-500">
                            <span class="text-sm text-gray-700">{{ conta.nome }}</span>
                        </label>
                        {% endfor %}
                    </div>
                </div>
                
                <!-- Instâncias do Brainrot (quando há múltiplos com o mesmo nome) -->
                {% if instancias and instancias|length > 0 %}
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-layer-group mr-2 text-purple-600"></i>Instâncias deste Brainrot
                    </label>
                    <div class="border border-gray-200 rounded-lg p-4 bg-gray-50">
                        <p class="text-sm text-gray-600 mb-3">
                            Este brainrot possui <strong>{{ instancias|length + 1 }}</strong> instância(s) com o mesmo nome. 
                            Cada instância pode ter valores, mutações e contas diferentes.
                        </p>
                        <div class="space-y-3">
                            <!-- Instância atual (que está sendo editada) -->
                            <div class="bg-white rounded-lg p-4 border-2 border-purple-500">
                                <div class="flex items-center justify-between mb-2">
                                    <h4 class="font-semibold text-gray-800">Instância Atual (editando)</h4>
                                    <span class="text-xs bg-purple-100 text-purple-700 px-2 py-1 rounded">ID: {{ brainrot.id }}</span>
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-3 text-sm">
                                    <div>
                                        <p class="text-gray-600">Valor/s</p>
                                        <p class="font-bold text-gray-800">{{ brainrot.valor_formatado if brainrot.valor_formatado else ('$' + (brainrot.valor_por_segundo | string) + '/s') }}</p>
                                    </div>
                                    <div>
                                        <p class="text-gray-600">Mutações</p>
                                        <p class="font-bold text-gray-800">{{ brainrot.numero_mutacoes }}</p>
                                    </div>
                                    <div>
                                        <p class="text-gray-600">Contas</p>
                                        <p class="font-bold text-gray-800">
                                            {% if brainrot.contas.all() %}
                                                {{ brainrot.contas.all()|map(attribute='nome')|join(', ') }}
                                            {% else %}
                                                Nenhuma
                                            {% endif %}
                                        </p>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Outras instâncias -->
                            {% for instancia in instancias %}
                            <div class="bg-white rounded-lg p-4 border border-gray-300 hover:border-purple-400 transition-colors">
                                <div class="flex items-center justify-between mb-2">
                                    <h4 class="font-medium text-gray-700">Instância #{{ loop.index + 1 }}</h4>
                                    <a href="{{ url_for('brainrot_edit', id=instancia.id) }}" 
                                       class="text-xs text-purple-600 hover:text-purple-700 font-medium">
                                        <i class="fas fa-edit mr-1"></i>Editar
                                    </a>
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-3 text-sm">
                                    <div>
                                        <p class="text-gray-600">Valor/s</p>
                                        <p class="font-bold text-gray-800">{{ instancia.valor_formatado }}</p>
                                    </div>
                                    <div>
                                        <p class="text-gray-600">Mutações</p>
                                        <p class="font-bold text-gray-800">{{ instancia.numero_mutacoes }}</p>
                                    </div>
                                    <div>
                                        <p class="text-gray-600">Contas</p>
                                        <p class="font-bold text-gray-800">
                                            {% if instancia.contas %}
                                                {{ instancia.contas|join(', ') }}
                                            {% else %}
                                                Nenhuma
                                            {% endif %}
                                        </p>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                {% endif %}
                
                <!-- Campos Personalizados -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Campos Personalizados</label>
                    <div id="campos-personalizados-container" class="space-y-3">
                        <!-- Campos serão adicionados via JavaScript -->
                    </div>
                    <button type="button" onclick="adicionarCampoPersonalizado()" 
                            class="mt-2 text-purple-600 hover:text-purple-700 text-sm font-medium">
                        <i class="fas fa-plus mr-1"></i>Adicionar Campo
                    </button>
                </div>
                
                <!-- Botões -->
                <div class="flex justify-end space-x-4 pt-6 border-t border-gray-200">
                    <a href="{{ url_for('brainrots_list') }}" 
                       class="px-6 py-3 rounded-lg font-medium text-gray-700 bg-gray-200 hover:bg-gray-300 transition-colors">
                        Cancelar
                    </a>
                    <button type="submit" class="btn-primary text-white px-6 py-3 rounded-lg font-medium">
                        <i class="fas fa-save mr-2"></i>Salvar
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const brainrotId = {{ brainrot.id if brainrot else 'null' }};
    const camposPersonalizadosExistentes = {{ (brainrot.get_campos_personalizados() | tojson) if brainrot else '{}' }};
    let campoCounter = 0;
    
    // Upload de imagem
    const uploadArea = document.getElementById('upload-area');
    const fotoInput = document.getElementById('foto-input');
    const fotoUrl = document.getElementById('foto-url');
    const previewImage = document.getElementById('preview-image');
    
    uploadArea.addEventListener('click', () => fotoInput.click());
    
    fotoInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            uploadImage(file);
        }
    });
    
    uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.classList.add('dragover');
    });
    
    uploadArea.addEventListener('dragleave', () => {
        uploadArea.classList.remove('dragover');
    });
    
    uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
        const file = e.dataTransfer.files[0];
        if (file && file.type.startsWith('image/')) {
            uploadImage(file);
        }
    });
    
    function uploadImage(file) {
        const formData = new FormData();
        formData.append('file', file);
        
        $.ajax({
            url: '/api/upload',
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            success: function(response) {
                if (response.success) {
                    fotoUrl.value = response.url;
                    previewImage.src = response.url;
                    previewImage.classList.remove('hidden');
                    uploadArea.querySelector('p').classList.add('hidden');
                    uploadArea.querySelector('i').classList.add('hidden');
                }
            },
            error: function() {
                alert('Erro ao fazer upload da imagem');
            }
        });
    }
    
    // Carregar campos personalizados existentes e valor formatado
    $(document).ready(function() {
        // Carregar valor formatado se existir
        {% if brainrot and brainrot.valor_formatado %}
        const valorFormatado = "{{ brainrot.valor_formatado }}";
        // Extrair número e formato do valor formatado (ex: $1.3B/s -> 1.3 e B/s)
        const match = valorFormatado.match(/\$?([\d.]+)([KMBT]?\/s)/i);
        if (match) {
            $('#valor_numero').val(match[1]);
            const formato = match[2] || '/s';
            $('#valor_formato').val(formato);
        } else {
            // Se não conseguir fazer match, tenta extrair só o número
            const numMatch = valorFormatado.match(/([\d.]+)/);
            if (numMatch) {
                $('#valor_numero').val(numMatch[1]);
            }
        }
        {% endif %}
        
        // Carregar campos personalizados existentes
        if (camposPersonalizadosExistentes && Object.keys(camposPersonalizadosExistentes).length > 0) {
            Object.keys(camposPersonalizadosExistentes).forEach(function(key) {
                adicionarCampoPersonalizado(key, camposPersonalizadosExistentes[key]);
            });
        }
    });
    
    function adicionarCampoPersonalizado(nome = '', valor = '') {
        campoCounter++;
        const html = `
            <div class="flex gap-3 items-end" id="campo-${campoCounter}">
                <div class="flex-1">
                    <input type="text" placeholder="Nome do campo" 
                           value="${nome}"
                           class="input-modern w-full px-4 py-2 rounded-lg focus:outline-none" 
                           name="campo_nome_${campoCounter}">
                </div>
                <div class="flex-1">
                    <input type="text" placeholder="Valor" 
                           value="${valor}"
                           class="input-modern w-full px-4 py-2 rounded-lg focus:outline-none" 
                           name="campo_valor_${campoCounter}">
                </div>
                <button type="button" onclick="removerCampoPersonalizado(${campoCounter})" 
                        class="text-red-600 hover:text-red-700 px-3 py-2">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        `;
        $('#campos-personalizados-container').append(html);
    }
    
    function removerCampoPersonalizado(id) {
        // Remover o campo do DOM
        const campoElement = $(`#campo-${id}`);
        if (campoElement.length) {
            campoElement.remove();
        }
    }
    
    // Submit do formulário
    $('#brainrot-form').on('submit', function(e) {
        e.preventDefault();
        
        // Montar valor formatado
        const valorNumero = $('#valor_numero').val().trim() || '0';
        const valorFormato = $('#valor_formato').val() || '/s';
        const valorFormatado = '$' + valorNumero + valorFormato;
        
        const dados = {
            nome: $('#nome').val(),
            foto: fotoUrl.value,
            raridade: $('#raridade').val(),
            valor_formatado: valorFormatado,
            valor_por_segundo: parseFloat(valorNumero) || 0,  // Mantido para compatibilidade
            quantidade: parseInt($('#quantidade').val()) || 1,
            numero_mutacoes: parseInt($('#numero_mutacoes').val()) || 0,
            contas: $('input[name="contas"]:checked').map(function() {
                return parseInt($(this).val());
            }).get(),
            campos_personalizados: {}
        };
        
        // Coletar campos personalizados APENAS dos que ainda estão no DOM
        // Campos removidos visualmente não serão incluídos aqui
        $('[id^="campo-"]').each(function() {
            const nome = $(this).find('input[name^="campo_nome_"]').val();
            const valor = $(this).find('input[name^="campo_valor_"]').val();
            // Só adiciona se tiver nome (permite valor vazio se o usuário quiser)
            // Campos com nome vazio são ignorados (campos novos não preenchidos)
            if (nome && nome.trim()) {
                dados.campos_personalizados[nome.trim()] = valor || '';
            }
        });
        
        const url = brainrotId ? `/api/brainrots/${brainrotId}` : '/api/brainrots';
        const method = brainrotId ? 'PUT' : 'POST';
        
        $.ajax({
            url: url,
            type: method,
            contentType: 'application/json',
            data: JSON.stringify(dados),
            success: function(response) {
                if (response.success) {
                    window.location.href = '/brainrots';
                }
            },
            error: function(xhr) {
                console.error('Erro ao salvar Brainrot:', xhr);
                let errorMsg = 'Erro ao salvar Brainrot.';
                if (xhr.responseJSON && xhr.responseJSON.error) {
                    errorMsg += '\n\nErro: ' + xhr.responseJSON.error;
                } else if (xhr.status === 0) {
                    errorMsg += '\n\nErro: Não foi possível conectar ao servidor. Verifique se o servidor está rodando.';
                } else if (xhr.status === 500) {
                    errorMsg += '\n\nErro: Erro interno do servidor. Verifique o terminal do servidor para mais detalhes.';
                } else {
                    errorMsg += '\n\nStatus: ' + xhr.status + '\nResposta: ' + xhr.responseText;
                }
                alert(errorMsg);
            }
        });
    });
</script>
{% endblock %}

